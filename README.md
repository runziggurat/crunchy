[![dependency status](https://deps.rs/repo/github/runziggurat/crunchy/status.svg)](https://deps.rs/repo/github/runziggurat/crunchy)

# crunchy
P2P network crawler data cruncher for graph metrics


# Running

`crunchy` gets three command line parameters: an input file, and an output file and ip cache file. All of them are `JSON` files.

The input file is a sample generated by our zcash crawler. Its format (a JSON-RPC response) corresponds to this:


```
{
    jsonrpc: String,
    result: {
        num_known_nodes: usize,
        num_good_nodes: usize,
        num_known_connections: usize,
        num_versions: usize,
        protocol_versions: HashMap<u32, usize>,
        user_agents: HashMap<String, usize>,
        crawler_runtime: Duration,
        node_addrs: Vec<SocketAddr>,
        nodes_indices: NodesIndices,
    }
    id: usize,
}
```

The generated output contains processed data that our renderer can directly use. It looks like this:

```
{
    elapsed: f64,
    nodes: [
        addr: SocketAddr,
        betweenness: f64,
        closeness: f64,
        cell_position: u32,
        cell_height: u32,
        connections: Vec<usize>,
        geolocation: Option<GeoInfo>
    ]
}
```
Explaination of the node fields:

- `addr`: the address as a dotted quad, with port number
- `betweenness`: the computed betweenness
- `closeness`: the computed closeness
- `cell_position`: corresponds to the z-coordinate positioning of a given node.
- `cell_height`: indicated the total number of nodes in a given cell (like a vertical column).
- `connections`: an array of indices corresponding to the connected nodes.
- `geolocation`: used for latitude, longitude, city, country

### More about `cell`:
Nodes at the same (or nearly the same) geolocation get grouped into a cell. This results in rendering a column of nodes, where each node gets its own position coordinate assigned. We use 0.2 degree granularity in both axes to determine cell membership.

### Command Line

```
Usage: ziggurat-crunchy [OPTIONS]

Options:
  -i, --input-sample <INPUT_SAMPLE>    Input file with sample data to process (overrides input from config file)
  -o, --out-state <OUT_STATE>          Output file with state of the graph (overrides output from config file)
  -g, --geocache-file <GEOCACHE_FILE>  Output file with geolocation cache (overrides cache from config file)
  -c, --config-file <CONFIG_FILE>      Configuration file path (if none defaults will be assumed)
  -h, --help                           Print help
  -V, --version                        Print version
```

The command line also prints the network parameters before and after applying the IPS algorithm output. Parameters are printed in the following format:

```
Statistics for the initial network:
----------------------------------------
Nodes count: 2472

Degree measures:
Average: 347.84021035598704
Median: 362
Min: 4, max: 468, delta: 464

Betweenness measures:
Average: 0.00020269540490710155
Median: 0.00021315968556486295
Min: 0.000000011402470586985047, max: 0.0005637115400558378, delta: 0.0005637001375852508

Closeness measures:
Average: 2.00092942092042
Median: 1.9982984574223353
Min: 1.996533523649682, max: 2.995343149165006, delta: 0.9988096255153243

Eigenvector measures:
Average: 1.0000000000000024
Median: 1.0408706699768735
Min: 0.009224464066643153, max: 1.338099762915545, delta: 1.3288752988489019
----------------------------------------

Statistics for the final network:
----------------------------------------
Nodes count: 2472

Degree measures:
Average: 350.2698220064725
Median: 363
Min: 5, max: 472, delta: 467

Betweenness measures:
Average: 0.00020269986625605759
Median: 0.00021142414089966258
Min: 0.000000011402470586985047, max: 0.0005637115400558378, delta: 0.0005637001375852508

Closeness measures:
Average: 2.000959540368865
Median: 1.999216689819378
Min: 1.996533523649682, max: 2.995343149165006, delta: 0.9988096255153243

Eigenvector measures:
Average: 1.0000000000000013
Median: 1.0369942301865014
Min: 0.015083344270596788, max: 1.3408045956582166, delta: 1.3257212513876198
----------------------------------------

Deltas for given statistics pair:
----------------------------------------
Nodes count: 0

Degree measures:
Average: 2.4296116504854695
Median: 1
Min: 1, max: 4, delta: 3

Betweenness measures:
Average: 0.0000000044613489560356
Median: -0.0000017355446652003617
Min: 0, max: 0, delta: 0

Closeness measures:
Average: 0.000030119448445109498
Median: 0.0009182323970426953
Min: 0, max: 0, delta: 0

Eigenvector measures:
Average: -0.0000000000000011102230246251565
Median: -0.0038764397903721104
Min: 0.005858880203953636, max: 0.0027048327426715257, delta: -0.0031540474612821168
----------------------------------------
```

Example:
```
cargo run --release -- -i testdata/sample.json -o testdata/state.json -g testdata/geoip-cache.json
```
