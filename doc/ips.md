# Intelligent Peer Sharing (IPS)

## Objective
Extend the crawler so that it is capable of recommending a peerlist optimized to another node’s maximum benefit.

## Concept
To achieve the objective Intelligent Peer Sharing has been introduced as a feature of crunchy. Crunchy works over „samples” generated by crawler. There are information about each node and that node’s connections (peers). Crunchy is using that data to calculate each node’s ratings and then run algorithm to select peers to be added/deleted for each node - called the IPS algorithm.

## The Algorithm

The Algorithm is divided into two main parts - security part and optimization part.

The main Algorithm itself contains a bunch of steps and conditions to choose new peerlist for the specified node. The Algorithm works for each node independently so previous changes to the network (previous peerlists generated) are not taken into account because there is no certainty that previous nodes apply those peerlists. Each peerlist is calculated over original network. Due to this it’s proposed to limit amount of peers changed for each node at once to limit potential bad decisions influence on network. Changing little amount of nodes at once create more evolutionary approach to network shaping.

The Algorithm itself is placed in `ips/algorithm.rs` file and is extensively commented.

### Factors
Following factors are taken into account when talking about network:
+ degree – tells how many direct, ‘one hop’ connections each node has to other nodes in the network. IPS is trying to keep it close to the network average - count average over the network and try to construct peerlist with neighbor count something in the middle between current degree and average.
+ betweenness – tells which nodes are in the middle between some nodes in a network. It does this by identifying all the shortest paths and then counting how many times each node falls on one. IPS is trying to keep it close to the network average for the node; node should search peers with high factor as it means that peer is often on the shortest path.
+ eigenvector – this tells how much influence node's neighbours have.
+ closeness – this measure calculates the shortest paths between all nodes, then assigns each node a score based on its sum of shortest paths. Not really important for the node here as being dense or sparse network is nothing bad. IPS tries to keep own centrality high and connect to peers with high closeness (if the MCDA wegiths allow it).

All of the above factors are present in the IPS result log, allowing to check how that particular run influenced the network. That can be treated as a network analysis before and after IPS work.

### Security checks

One of the most important param for the network topology is presence or absence of the network islands. Presence of the islands can influence on every other network or node parameter that we are takin care of. Merging two massive islands can be risky and shouldn't be done automatic. Both islands could be disconnected for a long time and therefore they can have their own blockchain history and their own reality. IPS detect such situations and breaks computations notifying the user that network is divided into pieces. 

Next, IPS is checking if network can be easily fragmented by attacking some % of the nodes and if so, preventing such case by creating new connections between their neighbours. Nodes to that simulation are chosen from the "hot" nodes so the nodes with highest betweenness factor. 

Last checks are connected to the network bridges - such graph edges are identified and algorithm prevent removing them to be sure there will be no new islands.

### Optimization

Selection is based on the "beauty" contest of the nodes - each node is evaluated basing on its degree, betweenness, closeness and eigenvector centrality. Then, if requested ranking is updated with location factor. Each factor has its own weight that is used to determine factor's importance to the calculation of the final ranking. That gives possibility to test different approaches to the selection of the peers, without re-compiling the code.
In fact, The Algorithm is multiple criteria decision analysis (MCDA) problem represented in criterion space (where criteria are evaluated instead of possible decisions). First approach is done using weighted sums method which allows to treat the problem as a special single criterion problem. One modification is allowance of using negative sums (the original method assumes all weights are positive).

Treating problem as MCDA allows to adapt The Algorithm to different types of networks (proposing eg. more sparse, more dense, more decentralized or opposite – centralized approaches).

Each node is rated based on the some factors and their weights. Each factor is normalized (X value to X’ normalized) to be able to create single ranking. 
Rating is computed as follows:

`rating = D * Dw + B * Bw + C * Cw + E * Ew + L * Lw`

where: <br />
`D` - degree <br />
`Dw` - degree weight <br />
`B` - betweenness <br />
`Bw` - betweenness weight <br />
`C` - closeness <br />
`Cw` - closeness weight <br />
`E` - eigenvector <br />
`Ew` - eigenvector weight <br />
`L` - location rating <br />
`Lw` - location weight <br />

**Note** that weights can be positive or negative giving ability to promote higher (big positive weight) or lower values (little positive weight) but also give bigger or lesser penalty (negative weights) to node’s overall ranking (as negative nodes result in factor subtraction from the overall result).

### Location

Node geographical location can be one of the factors taken into account when creating new peerlist. There could be two main approaches (one approach pros are cons for the other one and vice versa):
- prefer distant nodes – pros: distant nodes are not likely to suffer damages at the same time caused by blackouts, natural disasters etc.; ISP separation – distant nodes are not likely to run under the same ISP (who can suffer technical problems – DNS etc); cons: connection can be worse in terms of speed, latency and jitter;  
- refer closer nodes – pros: often the connection between closer nodes is better, if data is partitioned by location it’s more probable to have it closer to the data recipients; cons: likely to suffer the same problems – power failures, ISP problems etc;

There is also possibility to set location rating to off just to not take location into account.


## Configuration

The main idea is to allow as much as possible to be configurable using external file. Currently IPS is configurable using crunchy configuration file. IPS configuration section in crunchy configuration file looks following:

```
[ips_config]
peer_file_path = "testdata/peers.json"      #place to put output file
log_path = "ips.log"                        #place for log file
geolocation = "PreferCloser"                #location ranking should prefer closer or farther peers (Off, PreferDistant, PreferCloser)
geolocation_minmax_distance_km = 1000       #minimum or maximum distance in km for geolocation ranking
change_at_least = 1                         #minimum number of peers to change
change_no_more = 2                          #maximum number of peers to change
bridge_threshold_adjustment = 1.25          #adjustment to bridge threshold

[ips_config.mcda_weights]
location = 0.3
degree = -0.3
eigenvector = 0.2
betweenness = -0.3
closeness = 0.1
```

First section contains basic IPS configuration and the second one, weights to be used by MCDA algorithm. Sample config is placed under `testadata` directory.

User can easily adjust weights for each MCDA factor to promote different aspects.

## Final remarks

+ Performance is currently not taken into account. The only metric that gives any sight into performance is `handshake_time` which gives information about time elapsed between starting a connection and successful handshake between the node and the crawler. That is a one time metrics and can be affected by many factors like network delays or host load peak at the moment. Single measure can lead to false conclusions about the real performance of another node or network connection. Moreover, network performance between the crawler and the node tells nothing about possible performance of node_a to node_b.
+ Node’s own performance (hardware resources, system load etc.) can be a factor of possible node utilization in the network – either The Algorithm should try to put more traffic through that node or try to put it some further from the main traffic flow. Currently there is no way to get any of that information from the node from external network but here is the potential to find some enhancement.

## Sample

Sample results from IPS run:

```
IPS algorithm started...
Checking for nodes connected to themselves...
172.218.177.148:16125 is connected to itself.
154.53.63.9:16125 is connected to itself.
146.59.124.83:16125 is connected to itself.
37.187.88.103:16125 is connected to itself.
54.37.141.22:16125 is connected to itself.

...
[nodes connected to themself list]
...

37.59.134.165:16125 is connected to itself.
142.167.129.14:16125 is connected to itself.
65.108.99.214:16125 is connected to itself.
Generating initial network state and its statistics... 
Statistics for the initial network:
----------------------------------------
Nodes count: 6729

Degree measures:
Average: 1673.378510922871
Median: 1775
Min: 1, max: 2948, delta: 2947

Betweenness measures:
Average: 0.0006914887442478738
Median: 0.0007390585712156514
Min: 0, max: 0.002065442852915205, delta: 0.002065442852915205

Closeness measures:
Average: 2.0009819311242922
Median: 2.000098387783965
Min: 1.9989458610770605, max: 2.9992496962479973, delta: 1.0003038351709368

Eigenvector measures:
Average: 1.000000000000002
Median: 1.056610881384425
Min: 0.0005267475705698542, max: 1.7232354729355281, delta: 1.7227087253649582
----------------------------------------

Generated initial state and statistics in 383 s
IPS detected no islands
IPS detected no fragmentation possibility even when top nodes would be disconnected
The MCDA procedure is starting...
All IPS computations done in 412 s from IPS start
Statistics for the final network:
----------------------------------------
Nodes count: 6729

Degree measures:
Average: 1668.1619854361718
Median: 1776
Min: 2, max: 2910, delta: 2908

Betweenness measures:
Average: 0.0007233121796668225
Median: 0.0007800175457913357
Min: 0, max: 0.002065442852915205, delta: 0.002065442852915205

Closeness measures:
Average: 2.000953117674391
Median: 1.9996456008839623
Min: 1.9989458610770605, max: 2.9992496962479973, delta: 1.0003038351709368

Eigenvector measures:
Average: 1.0000000000000022
Median: 1.061306347054873
Min: 0.001138872735927244, max: 1.6923985711437681, delta: 1.691259698407841
----------------------------------------

Comparing if network parameters got changed on plus or minus:
Deltas for given statistics pair:
----------------------------------------
Nodes count: 0 (0.000%)

Degree measures:
Average: -5.216525486699311 (-0.312%)
Median: 1 (0.056%)
Min: 1 (100.000%), max: -38 (-1.289%), delta: -39 (-1.323%)

Betweenness measures:
Average: 0.00003182343541894867 (4.602%)
Median: 0.00004095897457568427 (5.542%)
Min: 0 (0.000%), max: 0 (0.000%), delta: 0 (0.000%)

Closeness measures:
Average: -0.00002881344990113277 (-0.001%)
Median: -0.0004527869000026108 (-0.023%)
Min: 0 (0.000%), max: 0 (0.000%), delta: 0 (0.000%)

Eigenvector measures:
Average: 0.0000000000000002220446049250313 (0.000%)
Median: 0.004695465670447874 (0.444%)
Min: 0.0006121251653573898 (116.208%), max: -0.03083690179176002 (-1.789%), delta: -0.031449026957117265 (-1.826%)
----------------------------------------

IPS has been working for 8848 seconds

```

```
IPS algorithm started...
Checking for nodes connected to themselves...
37.59.129.121:16125 is connected to itself.
51.178.98.198:16125 is connected to itself.
5.9.74.158:8233 is connected to itself.
138.201.252.11:8233 is connected to itself.
89.58.53.161:16125 is connected to itself.
5.161.81.6:16125 is connected to itself.

...
[nodes connected to themself list]
...

142.132.144.56:16125 is connected to itself.
57.128.152.20:16125 is connected to itself.
Generating initial network state and its statistics... 
Statistics for the initial network:
----------------------------------------
Nodes count: 2472

Degree measures:
Average: 347.84021035598704
Median: 362
Min: 4, max: 468, delta: 464

Betweenness measures:
Average: 0.00020269540490710155
Median: 0.00021315968556486295
Min: 0.000000011402470586985047, max: 0.0005637115400558378, delta: 0.0005637001375852508

Closeness measures:
Average: 2.00092942092042
Median: 1.9982984574223353
Min: 1.996533523649682, max: 2.995343149165006, delta: 0.9988096255153243

Eigenvector measures:
Average: 1.000000000000001
Median: 1.0408706699768735
Min: 0.009224464066643153, max: 1.338099762915545, delta: 1.3288752988489019
----------------------------------------

Generated initial state and statistics in 16 s
IPS detected no islands
IPS detected no fragmentation possibility even when top nodes would be disconnected
The MCDA procedure is starting...
All IPS computations done in 18 s from IPS start
Statistics for the final network:
----------------------------------------
Nodes count: 2472

Degree measures:
Average: 349.1383495145631
Median: 364
Min: 6, max: 465, delta: 459

Betweenness measures:
Average: 0.00020262725860806008
Median: 0.0002135033940386251
Min: 0.000000011402470586985047, max: 0.0005637115400558378, delta: 0.0005637001375852508

Closeness measures:
Average: 2.0007477447791993
Median: 1.9994259982940346
Min: 1.996533523649682, max: 2.995343149165006, delta: 0.9988096255153243

Eigenvector measures:
Average: 0.9999999999999994
Median: 1.0410820150716993
Min: 0.017614444104272146, max: 1.3234689707907403, delta: 1.3058545266864683
----------------------------------------

Comparing if network parameters got changed on plus or minus:
Deltas for given statistics pair:
----------------------------------------
Nodes count: 0 (0.000%)

Degree measures:
Average: 1.2981391585760775 (0.373%)
Median: 2 (0.552%)
Min: 2 (50.000%), max: -3 (-0.641%), delta: -5 (-1.078%)

Betweenness measures:
Average: -0.00000006814629904147132 (-0.034%)
Median: 0.0000003437084737621665 (0.161%)
Min: 0 (0.000%), max: 0 (0.000%), delta: 0 (0.000%)

Closeness measures:
Average: -0.0001816761412207768 (-0.009%)
Median: 0.0011275408716993063 (0.056%)
Min: 0 (0.000%), max: 0 (0.000%), delta: 0 (0.000%)

Eigenvector measures:
Average: -0.0000000000000016653345369377348 (-0.000%)
Median: 0.00021134509482578778 (0.020%)
Min: 0.008389980037628994 (90.954%), max: -0.014630792124804781 (-1.093%), delta: -0.02302077216243359 (-1.732%)
----------------------------------------

IPS has been working for 80 seconds

```
